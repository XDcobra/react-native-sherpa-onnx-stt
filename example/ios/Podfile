ENV['RCT_NEW_ARCH_ENABLED'] = '1'

# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, min_ios_version_supported
prepare_react_native_project!

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'SherpaOnnxSttExample' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )
    
    # Find SherpaOnnxStt pod and include its xcconfig for proper linking
    sherpa_pod = installer.pod_targets.find { |t| t.name == 'SherpaOnnxStt' }
    if sherpa_pod
      sherpa_pod_path = installer.sandbox.pod_dir('SherpaOnnxStt').to_s
      sherpa_xcconfig = File.join(sherpa_pod_path, 'ios', 'SherpaOnnxStt.xcconfig')
      
      puts "\n[SherpaOnnxStt] Configuring linker flags..."
      puts "[SherpaOnnxStt] Pod path: #{sherpa_pod_path}"
      
      xcframework_path = File.join(sherpa_pod_path, 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
      
      if File.exist?(sherpa_xcconfig) && File.exist?(xcframework_path)
        puts "[SherpaOnnxStt] Found xcconfig at: #{sherpa_xcconfig}"
        puts "[SherpaOnnxStt] Found XCFramework at: #{xcframework_path}"
        
        # Include the SherpaOnnxStt.xcconfig in the app's aggregated xcconfig files
        # First set SHERPA_ONNX_FRAMEWORK_PATH, then include the xcconfig
        pods_dir = installer.sandbox.root
        xcconfig_paths = Dir.glob(File.join(pods_dir, 'Target Support Files', 'Pods-SherpaOnnxSttExample', '*.xcconfig'))
        
        xcconfig_paths.each do |xcconfig_path|
          puts "[SherpaOnnxStt] Patching: #{File.basename(xcconfig_path)}"
          content = File.read(xcconfig_path)
          
          # Check if already includes our xcconfig
          if content.include?('SherpaOnnxStt.xcconfig')
            puts "[SherpaOnnxStt]   Already includes SherpaOnnxStt.xcconfig"
            next
          end
          
          # Add the framework path variable and include directive
          # The xcconfig uses SHERPA_ONNX_FRAMEWORK_PATH to build conditional paths
          content += "\n"
          content += "// SherpaOnnxStt: Set framework path and include xcconfig for conditional library linking\n"
          content += "SHERPA_ONNX_FRAMEWORK_PATH = #{xcframework_path}\n"
          content += "#include \"#{sherpa_xcconfig}\"\n"
          
          File.write(xcconfig_path, content)
          puts "[SherpaOnnxStt]   Added SHERPA_ONNX_FRAMEWORK_PATH and #include"
        end
        
        puts "[SherpaOnnxStt] Configuration complete"
      else
        puts "[SherpaOnnxStt] WARNING: xcconfig not found at #{sherpa_xcconfig}"
        puts "[SherpaOnnxStt] Falling back to manual patching..."
        
        # Fallback: manually patch if xcconfig doesn't exist
        xcframework_path = File.join(sherpa_pod_path, 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
        if File.exist?(xcframework_path)
          device_lib = File.join(xcframework_path, 'ios-arm64', 'libsherpa-onnx.a')
          simulator_lib = File.join(xcframework_path, 'ios-arm64_x86_64-simulator', 'libsherpa-onnx.a')
          
          pods_dir = installer.sandbox.root
          xcconfig_paths = Dir.glob(File.join(pods_dir, 'Target Support Files', 'Pods-SherpaOnnxSttExample', '*.xcconfig'))
          
          xcconfig_paths.each do |xcconfig_path|
            content = File.read(xcconfig_path)
            base_ldflags_match = content.match(/^OTHER_LDFLAGS\s*=\s*(.+)$/m)
            if base_ldflags_match
              base_ldflags = base_ldflags_match[1].strip
              content = content.gsub(/^OTHER_LDFLAGS\[sdk=.*\].*\n/, '')
              content += "\n// SherpaOnnxStt: Force load (fallback)\n"
              content += "OTHER_LDFLAGS[sdk=iphoneos*] = #{base_ldflags} -force_load \"#{device_lib}\"\n"
              content += "OTHER_LDFLAGS[sdk=iphonesimulator*] = #{base_ldflags} -force_load \"#{simulator_lib}\"\n"
              File.write(xcconfig_path, content)
            end
          end
        end
      end
    end
  end
end
