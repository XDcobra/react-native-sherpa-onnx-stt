name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      checks: read
    outputs:
      ios_run_id: ${{ steps.find-runs.outputs.ios_run_id }}
      android_run_id: ${{ steps.find-runs.outputs.android_run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Trigger iOS workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered iOS workflow');

      - name: Trigger Android workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered Android workflow');

      - name: Wait for iOS and Android workflows to complete
        id: wait-workflows
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 60 minutes
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            let iosRunId = null;
            let androidRunId = null;
            
            console.log('Waiting for iOS and Android workflows to complete...');
            
            while (Date.now() - startTime < maxWaitTime) {
              // Check iOS workflow
              if (!iosRunId) {
                const iosRuns = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'ios.yml',
                  ref: '${{ github.ref }}',
                  per_page: 5
                });
                
                // Find the most recent run that was triggered after we started
                const recentIosRun = iosRuns.data.workflow_runs.find(run => 
                  new Date(run.created_at) >= new Date(startTime - 60000) // 1 minute buffer
                );
                
                if (recentIosRun) {
                  if (recentIosRun.status === 'completed') {
                    if (recentIosRun.conclusion === 'success') {
                      iosRunId = recentIosRun.id;
                      console.log(`✓ iOS workflow completed successfully: ${iosRunId}`);
                    } else {
                      throw new Error(`iOS workflow failed with conclusion: ${recentIosRun.conclusion}`);
                    }
                  } else {
                    console.log(`iOS workflow status: ${recentIosRun.status} (run ${recentIosRun.id})`);
                  }
                }
              }
              
              // Check Android workflow
              if (!androidRunId) {
                const androidRuns = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'android.yml',
                  ref: '${{ github.ref }}',
                  per_page: 5
                });
                
                // Find the most recent run that was triggered after we started
                const recentAndroidRun = androidRuns.data.workflow_runs.find(run => 
                  new Date(run.created_at) >= new Date(startTime - 60000) // 1 minute buffer
                );
                
                if (recentAndroidRun) {
                  if (recentAndroidRun.status === 'completed') {
                    if (recentAndroidRun.conclusion === 'success') {
                      androidRunId = recentAndroidRun.id;
                      console.log(`✓ Android workflow completed successfully: ${androidRunId}`);
                    } else {
                      throw new Error(`Android workflow failed with conclusion: ${recentAndroidRun.conclusion}`);
                    }
                  } else {
                    console.log(`Android workflow status: ${recentAndroidRun.status} (run ${recentAndroidRun.id})`);
                  }
                }
              }
              
              // If both workflows are complete, break
              if (iosRunId && androidRunId) {
                break;
              }
              
              // Wait before next check
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            if (!iosRunId) {
              throw new Error('iOS workflow did not complete within timeout period');
            }
            
            if (!androidRunId) {
              throw new Error('Android workflow did not complete within timeout period');
            }
            
            core.setOutput('ios_run_id', iosRunId);
            core.setOutput('android_run_id', androidRunId);
            console.log(`\n✓ Both workflows completed successfully!`);
            console.log(`  iOS run ID: ${iosRunId}`);
            console.log(`  Android run ID: ${androidRunId}`);

      - name: Output workflow run IDs
        id: find-runs
        run: |
          echo "ios_run_id=${{ steps.wait-workflows.outputs.ios_run_id }}" >> $GITHUB_OUTPUT
          echo "android_run_id=${{ steps.wait-workflows.outputs.android_run_id }}" >> $GITHUB_OUTPUT

  create-release:
    runs-on: ubuntu-latest
    needs: trigger-builds
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Download iOS app bundle artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const iosRunId = '${{ needs.trigger-builds.outputs.ios_run_id }}';
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(iosRunId)
            });
            
            const iosArtifact = artifacts.data.artifacts.find(a => a.name === 'ios-app-bundle');
            if (!iosArtifact) {
              throw new Error('iOS app bundle artifact not found');
            }
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: iosArtifact.id,
              archive_format: 'zip'
            });
            
            const artifactPath = 'artifacts/ios';
            fs.mkdirSync(artifactPath, { recursive: true });
            fs.writeFileSync(path.join(artifactPath, 'artifact.zip'), Buffer.from(download.data));
            
            console.log(`Downloaded iOS artifact: ${iosArtifact.name}`);

      - name: Extract iOS artifact
        run: |
          cd artifacts/ios
          unzip -q artifact.zip
          rm artifact.zip
          cd ../..

      - name: Download Android APK artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const androidRunId = '${{ needs.trigger-builds.outputs.android_run_id }}';
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(androidRunId)
            });
            
            const androidArtifact = artifacts.data.artifacts.find(a => a.name === 'android-debug-apk');
            if (!androidArtifact) {
              throw new Error('Android APK artifact not found');
            }
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: androidArtifact.id,
              archive_format: 'zip'
            });
            
            const artifactPath = 'artifacts/android';
            fs.mkdirSync(artifactPath, { recursive: true });
            fs.writeFileSync(path.join(artifactPath, 'artifact.zip'), Buffer.from(download.data));
            
            console.log(`Downloaded Android artifact: ${androidArtifact.name}`);

      - name: Extract Android artifact
        run: |
          cd artifacts/android
          unzip -q artifact.zip -d .
          # The APK might be in a subdirectory, find and move it
          if [ -f "app-debug.apk" ]; then
            echo "Found APK at root"
          elif [ -f "*/app-debug.apk" ]; then
            mv */app-debug.apk app-debug.apk
            echo "Moved APK to root"
          else
            echo "APK structure:"
            find . -name "*.apk" -type f
            # Try to find and copy the APK
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            if [ -n "$APK_FILE" ]; then
              cp "$APK_FILE" app-debug.apk
              echo "Copied APK: $APK_FILE"
            fi
          fi
          rm -f artifact.zip
          cd ../..

      - name: Extract iOS artifact
        run: |
          cd artifacts/ios
          unzip -q artifact.zip
          rm artifact.zip
          cd ../..

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Find and copy iOS IPA file (already a valid .ipa archive)
          IPA_FILE=$(find artifacts/ios -name "*.ipa" -type f | head -1)
          if [ -n "$IPA_FILE" ]; then
            cp "$IPA_FILE" release-assets/SherpaOnnxSttExample.ipa
            echo "[OK] iOS IPA copied from: $IPA_FILE"
          else
            echo "Warning: iOS IPA file not found in artifacts"
            echo "Contents of artifacts/ios:"
            find artifacts/ios -type f || echo "No files found"
          fi
          
          # Copy Android APK (check multiple possible locations)
          ANDROID_APK=$(find artifacts/android -name "*.apk" -type f | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxSttExample-android-debug.apk
            echo "[OK] Android APK copied from: $ANDROID_APK"
          else
            echo "Warning: Android APK not found in artifacts"
            echo "Contents of artifacts/android:"
            find artifacts/android -type f || echo "No files found"
          fi
          
          # List release assets
          echo ""
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}
            
            ### iOS
            - **IPA**: `SherpaOnnxSttExample.ipa`
            
            ### Android
            - **Debug APK**: `SherpaOnnxSttExample-android-debug.apk`
            
            ---
            
            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*.ipa
            release-assets/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
